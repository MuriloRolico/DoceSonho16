<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Doce Sonho Confeitaria</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/base.css') }}">
    <style>
        :root {
            --primary-color: #d23f72;
            --primary-dark: #b22d5d;
            --secondary-color: #ffd6e0;
            --accent-color: #ffb3c6;
            --text-color: #2d2d2d;
            --light-text: #ffffff;
            --background-color: #fff8fa;
            --container-bg: #ffffff;
            --border-color: #f1c2ce;
            --shadow: 0 8px 20px rgba(210, 63, 114, 0.08);
            --radius: 10px;
        }

        body, html {
            scroll-behavior: smooth;
            background-color: var(--background-color);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.8;
            color: var(--text-color);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.5px;
        }

        /* Barra de navegação */
        .navbar {
            background-color: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            padding: 15px 0;
        }

        .navbar-brand {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.8rem;
            letter-spacing: 1px;
        }

        .nav-link {
            font-weight: 500;
            color: var(--text-color) !important;
            margin: 0 12px;
            padding: 8px 16px;
            border-radius: 30px;
            transition: all 0.3s ease;
            position: relative;
            background: transparent;
            border: none;
        }

        .nav-link:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            background-color: var(--primary-color);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-link:hover:after {
            width: 70%;
        }

        .nav-link:hover {
            color: var(--primary-color) !important;
            transform: translateY(-2px);
        }

        .nav-link.active {
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        .navbar-nav .badge {
            background-color: var(--primary-color) !important;
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(25%, -25%);
        }

        /* Cards de perfil */
        .card {
            border-radius: var(--radius);
            border: none;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            background-color: var(--container-bg);
            margin-bottom: 25px;
        }

        .card:hover {
            box-shadow: 0 12px 30px rgba(210, 63, 114, 0.12);
            transform: translateY(-5px);
        }

        .card-header {
            border-top-left-radius: var(--radius) !important;
            border-top-right-radius: var(--radius) !important;
            background-color: var(--primary-color);
            border: none;
            padding: 15px 20px;
        }

        .card-header h5 {
            margin: 0;
            color: var(--light-text);
            font-weight: 600;
        }

        .card-body {
            padding: 25px;
        }

        /* Botões */
        .btn {
            border-radius: 30px;
            font-weight: 600;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(178, 45, 93, 0.2);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(178, 45, 93, 0.2);
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(90, 98, 104, 0.2);
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.2);
        }

        /* Formulários */
        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(210, 63, 114, 0.25);
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        /* Imagem do perfil */
        .profile-img-container {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            position: relative;
        }

        .profile-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            padding: 3px;
            transition: all 0.3s ease;
        }

       /* Footer */
        footer {
            background-color: #2d2d2d !important;
            color: #f8f8f8 !important;
            padding: 80px 0 30px;
            position: relative;
        }

        footer:before {
            content: '';
            position: absolute;
            top: -50px;
            left: 0;
            width: 100%;
            height: 100px;
            background-color: white;
            clip-path: ellipse(50% 50px at 50% 50px);
        }

        .footer-heading {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 25px;
            position: relative;
            display: inline-block;
        }

        .footer-heading:after {
            content: '';
            position: absolute;
            width: 40px;
            height: 2px;
            background-color: var(--primary-color);
            bottom: -10px;
            left: 0;
        }

        .footer-text {
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .footer-social {
            margin-top: 25px;
        }

        .footer-social a {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.1);
            color: white;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .footer-social a:hover {
            background-color: var(--primary-color);
            transform: translateY(-3px);
        }

        .footer-links {
            list-style: none;
            padding-left: 0;
        }

        .footer-links li {
            margin-bottom: 12px;
        }

        .footer-links a {
            color: #aaa;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .footer-links a:hover {
            color: white;
            transform: translateX(5px);
        }

        .footer-contact li {
            color: #aaa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .footer-contact-icon {
            margin-right: 15px;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .footer-form .form-control {
            background-color: rgba(255,255,255,0.08);
            border: none;
            color: white;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .footer-form .form-control::placeholder {
            color: #aaa;
        }

        .footer-form .form-control:focus {
            background-color: rgba(255,255,255,0.12);
            box-shadow: none;
        }

        .footer-form .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 25px;
            border-radius: 5px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }

        .footer-form .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
        }

        .footer-bottom {
            padding-left: 30px;
            padding-top: 30px;
            margin-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .footer-copyright {
            color: #aaa;
        }

        .footer-policy a {
            color: #aaa;
            margin-left: 20px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .footer-policy a:hover {
            color: white;
        }
        /* Modais */
        .modal-content {
            border-radius: var(--radius);
            border: none;
            box-shadow: var(--shadow);
        }

        .modal-header {
            border-bottom: none;
            padding: 20px 25px 10px;
        }

        .modal-footer {
            border-top: none;
            padding: 10px 25px 20px;
        }

        /* Mensagens flash */
        .alert {
            border-radius: var(--radius);
            border: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        /* WhatsApp float */
        .whatsapp-float a {
            background-color: #25D366;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .whatsapp-float a:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Tabs styling */
        .nav-tabs {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 10px 20px;
            margin-right: 5px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-tabs .nav-link:hover {
            border: none;
            color: var(--primary-color);
        }
        
        .nav-tabs .nav-link.active {
            border: none;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .nav-tabs .nav-link.active:after {
            content: '';
            position: absolute;
            bottom: -2px;
            
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
        }

        /* Estilos para dados mascarados */
        .masked-data {
            filter: blur(4px);
            transition: filter 0.3s ease;
            user-select: none;
        }

        /* Switch para ativar/desativar mascaramento */
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            margin-left: 0;
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Dica para dados mascarados */
        .masked-data-tip {
            display: none;
            position: absolute;
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            z-index: 10;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .masked-data:hover .masked-data-tip {
            display: block;
        }

        /* Novos badges de segurança */
        .security-badge {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }
        
        .security-badge i {
            margin-right: 5px;
        }

        /* Timeline de atividade */
        .activity-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .activity-timeline:before {
            content: '';
            position: absolute;
            top: 0;
            left: 8px;
            height: 100%;
            width: 2px;
            background-color: var(--border-color);
        }
        
        .activity-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .activity-dot {
            position: absolute;
            left: -30px;
            top: 5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 3px solid var(--background-color);
            z-index: 1;
        }
        
        .activity-date {
            font-size: 0.8rem;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
        }

        /* Mapa e localizador */
        #map {
            height: 300px;
            width: 100%;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .location-verified {
            display: inline-flex;
            align-items: center;
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .location-verified i {
            margin-right: 5px;
        }

        .address-confirmation {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .cep-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Modal para Confirmar Logout -->
    <div class="modal fade" id="confirmarLogoutModal" tabindex="-1" aria-labelledby="confirmarLogoutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmarLogoutModalLabel">Confirmar Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja sair da sua conta?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-primary">Sim, sair</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de navegação -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">Doce Sonho</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if 'usuario_id' in session %}
                    <li class="nav-item">
                         <a class="nav-link" href="{{ url_for('product.todos_produtos') }}">Produtos</a>
                         
                    </li>
                    {% if is_admin() %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin.admin_produtos') }}">Admin</a>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('cart.carrinho') }}">
                            <i class="bi bi-cart3 me-1"></i>
                            {% if 'carrinho' in session and session['carrinho'] %}
                            <span class="badge bg-danger">{{ session['carrinho']|length }}</span>
                            {% endif %}
                        </a>
                    </li>
                    {% if 'usuario_id' in session %}
                   
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#confirmarLogoutModal">
                            <i class="bi bi-box-arrow-right me-1"></i>Logout
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.login') }}">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.registro') }}">
                            <i class="bi bi-person-plus me-1"></i>Registrar
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Mensagens Flash -->
    <div class="container mt-4">
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
        
        <!-- Cabeçalho do Perfil -->
        <section class="py-4">
            <div class="row align-items-center mb-4">
                <div class="col-md-6">
                    <h1 class="mb-0">Meu Perfil</h1>
                    <p class="text-muted">Gerencie suas informações pessoais e preferências</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <!-- Switch para ativar/desativar mascaramento de dados -->
                    <div class="form-check form-switch d-inline-flex align-items-center">
                        <input class="form-check-input me-2" type="checkbox" id="toggleDataMasking" checked>
                        <label class="form-check-label" for="toggleDataMasking">
                            <i class="bi bi-shield-lock me-1"></i>Mascarar Dados Sensíveis
                        </label>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Conteúdo Perfil -->
        <section class="pb-5">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card shadow">
                        <div class="card-body text-center py-4">
                            <div class="profile-img-container mb-4">
                                {% if usuario.foto_perfil %}
                                <img src="{{ usuario.foto_perfil }}" class="profile-img" alt="Foto de perfil">
                                {% else %}
                                <img src="{{ url_for('static', filename='img/default-profile.png') }}" class="profile-img" alt="Foto de perfil padrão">
                                {% endif %}
                            </div>
                            <h3 class="card-title mb-2">{{ usuario.nome }}</h3>
                            <p class="text-muted mb-1">
                                <span class="data-field" data-type="email">{{ usuario.email }}</span>
                             
                            </p>
                            <p class="text-muted">Membro desde {{ usuario.data_registro.strftime('%d/%m/%Y') }}</p>
                            
                            <div class="d-grid gap-3 mt-4">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#alterarFotoModal">
                                    <i class="bi bi-camera me-2"></i>Alterar Foto
                                </button>
                                <a href="{{ url_for('user.exportar_dados') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-download me-2"></i>Exportar Meus Dados
                                </a>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#excluirContaModal">
                                    <i class="bi bi-trash me-2"></i>Excluir Minha Conta
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card de Atividade Recente -->
                    <div class="card shadow">
                        <div class="card-header">
                            <h5 class="mb-0">Atividade Recente</h5>
                        </div>
                        <div class="card-body">
                            <div class="activity-timeline">
                                <div class="activity-item">
                                    <div class="activity-dot"></div>
                                    <span class="activity-date">{{ (usuario.ultimo_acesso or usuario.data_registro).strftime('%d/%m/%Y %H:%M') }}</span>
                                    <p class="mb-0">Último acesso ao sistema</p>
                                </div>
                                
                                {% if usuario.ultimo_acesso and usuario.ultimo_acesso != usuario.data_registro %}
                                <div class="activity-item">
                                    <div class="activity-dot"></div>
                                    <span class="activity-date">{{ usuario.data_registro.strftime('%d/%m/%Y') }}</span>
                                    <p class="mb-0">Conta criada</p>
                                </div>
                                {% endif %}
                                
                                {% if pedidos and pedidos|length > 0 %}
                                <div class="activity-item">
                                    <div class="activity-dot"></div>
                                    <span class="activity-date">{{ pedidos[0].data.strftime('%d/%m/%Y %H:%M') }}</span>
                                    <p class="mb-0">Pedido mais recente</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <!-- Abas -->
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">
                                <i class="bi bi-person me-2"></i>Informações Básicas
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="endereco-tab" data-bs-toggle="tab" data-bs-target="#endereco" type="button" role="tab" aria-controls="endereco" aria-selected="false">
                                <i class="bi bi-geo-alt me-2"></i>Endereço
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="senha-tab" data-bs-toggle="tab" data-bs-target="#senha" type="button" role="tab" aria-controls="senha" aria-selected="false">
                                <i class="bi bi-shield-lock me-2"></i>Segurança
                            </button>
                        </li>
                        
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <!-- Aba de Informações Básicas -->
                        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                            <div class="card shadow">
                                <div class="card-header">
                                    <h5 class="mb-0">Informações Básicas</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('user.atualizar_perfil') }}">
                                        <div class="form-group mb-4">
                                            <label for="nome" class="form-label">Nome Completo:</label>
                                            <input type="text" id="nome" name="nome" value="{{ usuario.nome }}" required class="form-control">
                                        </div>
                                        <div class="form-group mb-4">
                                            <label for="email" class="form-label">Email:</label>
                                            <input type="email" id="email" name="email" class="form-control" value="{{ usuario.email }}" readonly>
                                            <small class="form-text text-muted">E-mail somente para visualização</small>
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-check-circle me-2"></i>Salvar Alterações
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Aba de Endereço -->
                        <div class="tab-pane fade" id="endereco" role="tabpanel" aria-labelledby="endereco-tab">
                            <div class="card shadow">
                                <div class="card-header">
                                    <h5 class="mb-0">Endereço</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('user.atualizar_perfil') }}" id="endereco-form">
                                        <div class="row">
                                            <div class="col-md-5 mb-3">
                                                <label for="endereco_cep" class="form-label">CEP:</label>
                                                <div class="input-group">
                                                    <input type="text" id="endereco_cep" name="endereco_cep" class="form-control data-field" data-type="cep" value="{{ usuario.endereco_cep or '' }}" placeholder="00000-000">
                                                    <button class="btn btn-outline-secondary" type="button" id="buscarCep">
                                                        <i class="bi bi-search"></i>
                                                    </button>
                                                </div>
                                                <small class="form-text text-muted">Digite o CEP para buscar automaticamente</small>
                                            </div>
                                        </div>
                                        
                                        <div id="cep-feedback" class="mb-3" style="display: none;">
                                            <!-- Feedback dinâmico para busca de CEP -->
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="endereco_rua" class="form-label">Rua:</label>
                                                <input type="text" id="endereco_rua" name="endereco_rua" class="form-control data-field" data-type="endereco" value="{{ usuario.endereco_rua or '' }}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="endereco_numero" class="form-label">Número:</label>
                                                <input type="text" id="endereco_numero" name="endereco_numero" class="form-control data-field" data-type="endereco" value="{{ usuario.endereco_numero or '' }}">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="endereco_complemento" class="form-label">Complemento:</label>
                                            <input type="text" id="endereco_complemento" name="endereco_complemento" class="form-control data-field" data-type="endereco" value="{{ usuario.endereco_complemento or '' }}" placeholder="Apto, Bloco, etc.">
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="endereco_bairro" class="form-label">Bairro:</label>
                                                <input type="text" id="endereco_bairro" name="endereco_bairro" class="form-control data-field" data-type="endereco" value="{{ usuario.endereco_bairro or '' }}">
                                            </div>
                                            <div class="col-md-5 mb-3">
                                                <label for="endereco_cidade" class="form-label">Cidade:</label>
                                                <input type="text" id="endereco_cidade" name="endereco_cidade" class="form-control data-field" data-type="endereco" value="{{ usuario.endereco_cidade or '' }}">
                                            </div>
                                            <div class="col-md-3 mb-4">
                                                <label for="endereco_estado" class="form-label">Estado:</label>
                                                <select id="endereco_estado" name="endereco_estado" class="form-select data-field" data-type="endereco">
                                                    <option value="">Selecione</option>
                                                    <option value="AC" {% if usuario.endereco_estado == 'AC' %}selected{% endif %}>AC</option>
                                                    <option value="AL" {% if usuario.endereco_estado == 'AL' %}selected{% endif %}>AL</option>
                                                    <option value="AP" {% if usuario.endereco_estado == 'AP' %}selected{% endif %}>AP</option>
                                                    <option value="AM" {% if usuario.endereco_estado == 'AM' %}selected{% endif %}>AM</option>
                                                    <option value="BA" {% if usuario.endereco_estado == 'BA' %}selected{% endif %}>BA</option>
                                                    <option value="CE" {% if usuario.endereco_estado == 'CE' %}selected{% endif %}>CE</option>
                                                    <option value="DF" {% if usuario.endereco_estado == 'DF' %}selected{% endif %}>DF</option>
                                                    <option value="ES" {% if usuario.endereco_estado == 'ES' %}selected{% endif %}>ES</option>
                                                    <option value="GO" {% if usuario.endereco_estado == 'GO' %}selected{% endif %}>GO</option>
                                                    <option value="MA" {% if usuario.endereco_estado == 'MA' %}selected{% endif %}>MA</option>
                                                    <option value="MT" {% if usuario.endereco_estado == 'MT' %}selected{% endif %}>MT</option>
                                                    <option value="MS" {% if usuario.endereco_estado == 'MS' %}selected{% endif %}>MS</option>
                                                    <option value="MG" {% if usuario.endereco_estado == 'MG' %}selected{% endif %}>MG</option>
                                                    <option value="PA" {% if usuario.endereco_estado == 'PA' %}selected{% endif %}>PA</option>
                                                    <option value="PB" {% if usuario.endereco_estado == 'PB' %}selected{% endif %}>PB</option>
                                                    <option value="PR" {% if usuario.endereco_estado == 'PR' %}selected{% endif %}>PR</option>
                                                    <option value="PE" {% if usuario.endereco_estado == 'PE' %}selected{% endif %}>PE</option>
                                                    <option value="PI" {% if usuario.endereco_estado == 'PI' %}selected{% endif %}>PI</option>
                                                    <option value="RJ" {% if usuario.endereco_estado == 'RJ' %}selected{% endif %}>RJ</option>
                                                    <option value="RN" {% if usuario.endereco_estado == 'RN' %}selected{% endif %}>RN</option>
                                                    <option value="RS" {% if usuario.endereco_estado == 'RS' %}selected{% endif %}>RS</option>
                                                    <option value="RO" {% if usuario.endereco_estado == 'RO' %}selected{% endif %}>RO</option>
                                                    <option value="RR" {% if usuario.endereco_estado == 'RR' %}selected{% endif %}>RR</option>
                                                    <option value="SC" {% if usuario.endereco_estado == 'SC' %}selected{% endif %}>SC</option>
                                                    <option value="SP" {% if usuario.endereco_estado == 'SP' %}selected{% endif %}>SP</option>
                                                    <option value="SE" {% if usuario.endereco_estado == 'SE' %}selected{% endif %}>SE</option>
                                                    <option value="TO" {% if usuario.endereco_estado == 'TO' %}selected{% endif %}>TO</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Mapa -->
                                        <div id="map-container">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="mb-0">Localização no Mapa</h6>
                                                <button type="button" id="verificarMapa" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-geo-alt-fill me-2"></i>Verificar no Mapa
                                                </button>
                                            </div>
                                            <div id="map"></div>
                                            
                                            <div id="location-confirmation" style="display: none;" class="mt-3 address-confirmation">
                                                <h6 class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Endereço Confirmado</h6>
                                                <p id="endereco-confirmado" class="mb-0"></p>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid mt-4">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-geo-alt me-2"></i>Salvar Endereço
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba de Segurança -->
                        <div class="tab-pane fade" id="senha" role="tabpanel" aria-labelledby="senha-tab">
                            <div class="card shadow">
                                <div class="card-header">
                                    <h5 class="mb-0">Alterar Senha</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-4">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        Recomendamos alterar sua senha periodicamente para maior segurança.
                                    </div>
                                    
                                    <form method="POST" action="{{ url_for('user.alterar_senha') }}">
                                        <div class="form-group mb-4">
                                            <label for="senha_atual" class="form-label">Senha Atual:</label>
                                            <input type="password" id="senha_atual" name="senha_atual" class="form-control" required>
                                        </div>
                                        <div class="form-group mb-4">
                                            <label for="nova_senha" class="form-label">Nova Senha:</label>
                                            <input type="password" id="nova_senha" name="nova_senha" class="form-control" required 
                                                   pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$" 
                                                   title="A senha deve conter pelo menos 8 caracteres, incluindo letras maiúsculas, minúsculas, números e caracteres especiais">
                                        </div>
                                        <div class="form-group mb-4">
                                            <label for="confirmar_nova_senha" class="form-label">Confirmar Nova Senha:</label>
                                            <input type="password" id="confirmar_nova_senha" name="confirmar_nova_senha" class="form-control" required>
                                        </div>
                                        
                                        <div class="password-strength mb-4">
                                            <h6 class="mb-2">Requisitos de segurança:</h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                <span class="badge bg-light text-dark" id="req-length"><i class="bi bi-x-circle me-1"></i>Mínimo 8 caracteres</span>
                                                <span class="badge bg-light text-dark" id="req-lowercase"><i class="bi bi-x-circle me-1"></i>Letra minúscula</span>
                                                <span class="badge bg-light text-dark" id="req-uppercase"><i class="bi bi-x-circle me-1"></i>Letra maiúscula</span>
                                                <span class="badge bg-light text-dark" id="req-number"><i class="bi bi-x-circle me-1"></i>Número</span>
                                                <span class="badge bg-light text-dark" id="req-special"><i class="bi bi-x-circle me-1"></i>Caractere especial</span>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-shield-lock me-2"></i>Alterar Senha
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Card de Sessões Ativas -->
                            <div class="card shadow mt-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Sessões Ativas</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">Sessão Atual</h6>
                                                <p class="mb-1 small text-muted">{{ request.user_agent.string }}</p>
                                                <small class="text-muted">{{ usuario.ultimo_acesso.strftime('%d/%m/%Y %H:%M') if usuario.ultimo_acesso else 'Agora' }}</small>
                                            </div>
                                            <span class="badge bg-success">Atual</span>
                                        </div>
                                        
                                        {% for token in tokens %}
                                        {% if not token.is_revogado and token.token != session.get('auth_token') %}
                                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">Outro Dispositivo</h6>
                                                <p class="mb-1 small text-muted">{{ token.device_info }}</p>
                                                <small class="text-muted">{{ token.data_criacao.strftime('%d/%m/%Y %H:%M') }}</small>
                                            </div>
                                            <form method="POST" action="{{ url_for('user.revogar_token', token_id=token.id) }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">Encerrar</button>
                                            </form>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="d-grid mt-3">
                                        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger">
                                            <i class="bi bi-x-circle me-2"></i>Encerrar Todas as Sessões
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal para Alterar Foto -->
    <div class="modal fade" id="alterarFotoModal" tabindex="-1" aria-labelledby="alterarFotoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alterarFotoModalLabel">Alterar Foto de Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('user.atualizar_foto') }}" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <div class="profile-img-container">
                                {% if usuario.foto_perfil %}
                                <img src="{{ usuario.foto_perfil }}" class="profile-img preview-img" alt="Foto de perfil">
                                {% else %}
                                <img src="{{ url_for('static', filename='img/default-profile.png') }}" class="profile-img preview-img" alt="Foto de perfil padrão">
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="foto_perfil" class="form-label">Selecione uma nova foto:</label>
                            <input class="form-control" type="file" id="foto_perfil" name="foto_perfil" accept="image/*" required>
                            <div class="form-text mt-2">Formatos permitidos: JPG, JPEG, PNG, GIF. Tamanho máximo: 5MB.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Excluir Conta -->
    <div class="modal fade" id="excluirContaModal" tabindex="-1" aria-labelledby="excluirContaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="excluirContaModalLabel">Confirmação de Exclusão de Conta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('user.excluir_conta') }}">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Atenção!</strong> Esta ação é irreversível.
                        </div>
                        <p>Ao excluir sua conta, todas as suas informações pessoais, histórico de pedidos e bolos personalizados serão permanentemente removidos.</p>
                        <div class="mb-4">
                            <label for="confirmar_senha" class="form-label">Digite sua senha para confirmar:</label>
                            <input type="password" class="form-control" id="confirmar_senha" name="confirmar_senha" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmar_exclusao" name="confirmar_exclusao" required>
                            <label class="form-check-label" for="confirmar_exclusao">
                                Eu entendo que esta ação é irreversível e desejo excluir minha conta
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Excluir Conta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Rodapé com área de contato -->
    <footer>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-4 col-md-6">
                    <h4 class="footer-heading">Doce Sonho Confeitaria</h4>
                    <p class="footer-text">Transformamos ingredientes selecionados em momentos doces e inesquecíveis desde 2015. Nossa paixão é adoçar sua vida com sabores especiais.</p>
                    <div class="footer-social">
                        <a href="#"><i class="bi bi-facebook"></i></a>
                        <a href="#"><i class="bi bi-instagram"></i></a>
                        <a href="#"><i class="bi bi-whatsapp"></i></a>
                        <a href="#"><i class="bi bi-tiktok"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6">
                    <h4 class="footer-heading">Links Rápidos</h4>
                    <ul class="footer-links">
                        <li><a href="{{ url_for('index') }}">Início</a></li>
                        <li><a href="{{ url_for('product.todos_produtos') }}">Produtos</a></li>
                        <li><a href="{{ url_for('product.montar_bolo') }}">Monte seu Bolo</a></li>
                        <li><a href="{{ url_for('sobrenos.sobrenos') }}">Sobre Nós</a></li>                      
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h4 class="footer-heading">Contato</h4>
                    <ul class="footer-links footer-contact">
                        <li>
                            <i class="bi bi-geo-alt footer-contact-icon"></i>
                            Rua das Flores, 123 - Centro
                        </li>
                        <li>
                            <i class="bi bi-telephone footer-contact-icon"></i>
                            (11) 9999-9999
                        </li>
                        <li>
                            <i class="bi bi-envelope footer-contact-icon"></i>
                            contato@docesonho.com.br
                        </li>
                        <li>
                            <i class="bi bi-clock footer-contact-icon"></i>
                            Seg-Sex: 9h às 18h | Sáb: 9h às 14h
                        </li>
                    </ul>
                </div>
               
            </div>
            <div class="footer-bottom">
                <div class="row">
                    <div class="col-md-6">
                        <p class="footer-copyright">&copy; 2025 Doce Sonho Confeitaria. Todos os direitos reservados.</p>
                    </div>
                    <div class="col-md-6 text-md-end footer-policy">
                         <a href="{{ url_for('auth.politica_privacidade') }}">Política de Privacidade</a>
                     
                        <a href="#">Termos de Uso</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Botão de WhatsApp flutuante -->
    <div class="whatsapp-float">
        <a href="https://wa.me/5511999999999" target="_blank" class="btn btn-success rounded-circle position-fixed bottom-0 end-0 m-4 p-3">
            <i class="bi bi-whatsapp fs-4"></i>
        </a>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    

    
    <!-- Script para o perfil -->
    <script>
    // ========================================
// SCRIPT COMPLETO - PERFIL COM GOOGLE MAPS
// ========================================

// Variáveis globais
let mapInitialized = false;
let map;
let marker;
let geocoder;
let dataMaskingEnabled = true; // Variável em memória em vez de localStorage

// ========================================
// FUNÇÕES DO GOOGLE MAPS
// ========================================

// Função global para inicialização do mapa que será chamada como callback
function initMapCallback() {
    function initMapCallback() {
    console.log('Google Maps API carregada com sucesso');
    mapInitialized = true;
    
    // Se a aba de endereço já estiver aberta, inicialize o mapa
    const enderecoTab = document.querySelector('#endereco-tab.active');
    if (enderecoTab) {
        setTimeout(initMap, 100);
    }
}

// Função para carregar o script do Google Maps de forma dinâmica
function loadGoogleMapsScript() {
    const script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBGMk-s2L8-vPq74rp_slDz56ItjXK6GFM&libraries=places&callback=initMapCallback';
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
    console.log('Script do Google Maps adicionado dinamicamente');
}

// Carregar o script após a página estar pronta
document.addEventListener('DOMContentLoaded', function() {
    // Resto do código DOMContentLoaded
    
    // Carregar o script do Google Maps após um pequeno delay
    setTimeout(loadGoogleMapsScript, 500);
});
}

// Inicializar mapa
function initMap() {
    try {
        if (!window.google || !window.google.maps) {
            console.error('Google Maps API não foi carregada corretamente');
            mostrarFeedbackCep('alert-warning', 'Não foi possível carregar o mapa. Tente recarregar a página.');
            return;
        }
        
        console.log('Inicializando mapa...');
        geocoder = new google.maps.Geocoder();
        
        // Coordenadas padrão (Brasília, Brasil)
        const defaultLatLng = {lat: -15.77972, lng: -47.92972};
        
        // Elemento do mapa
        const mapElement = document.getElementById("map");
        if (!mapElement) {
            console.error('Elemento do mapa (#map) não encontrado');
            return;
        }
        
        // Configurar mapa
        map = new google.maps.Map(mapElement, {
            center: defaultLatLng,
            zoom: 4,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            zoomControl: true,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        
        console.log('Mapa inicializado com sucesso');
        
        // Verifica se já existe um endereço para exibir
        const temEndereco = verificarCamposEndereco();
        if (temEndereco) {
            setTimeout(verificarEnderecoNoMapa, 500);
        }
        
    } catch (error) {
        console.error('Erro ao inicializar o mapa:', error);
        mostrarFeedbackCep('alert-danger', 'Erro ao carregar o mapa. Tente novamente mais tarde.');
    }
}

// Verificar se os campos de endereço estão preenchidos
function verificarCamposEndereco() {
    const rua = document.getElementById('endereco_rua')?.value?.trim();
    const cidade = document.getElementById('endereco_cidade')?.value?.trim();
    const estado = document.getElementById('endereco_estado')?.value?.trim();
    
    return rua && cidade && estado;
}

// Verificar endereço no mapa
function verificarEnderecoNoMapa() {
    if (!map || !geocoder) {
        mostrarFeedbackCep('alert-warning', 'O mapa ainda não foi carregado. Aguarde um momento e tente novamente.');
        return;
    }
    
    const rua = document.getElementById('endereco_rua')?.value?.trim() || '';
    const numero = document.getElementById('endereco_numero')?.value?.trim() || '';
    const bairro = document.getElementById('endereco_bairro')?.value?.trim() || '';
    const cidade = document.getElementById('endereco_cidade')?.value?.trim() || '';
    const estado = document.getElementById('endereco_estado')?.value?.trim() || '';
    
    if (!rua || !cidade || !estado) {
        mostrarFeedbackCep('alert-warning', 'Preencha pelo menos rua, cidade e estado para visualizar no mapa.');
        return;
    }
    
    // Montar endereço completo para geocoding
    const endereco = `${rua}, ${numero || 's/n'}, ${bairro ? bairro + ', ' : ''}${cidade} - ${estado}, Brasil`;
    console.log('Buscando endereço:', endereco);
    
    // Mostrar carregamento no botão
    const verificarMapaBtn = document.getElementById('verificarMapa');
    const btnOriginalText = '<i class="bi bi-geo-alt-fill me-2"></i>Verificar no Mapa';
    const btnLoadingText = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Localizando...';
    
    if (verificarMapaBtn) {
        verificarMapaBtn.innerHTML = btnLoadingText;
        verificarMapaBtn.disabled = true;
    }
    
    // Fazer geocoding
    geocoder.geocode({ 
        'address': endereco,
        'region': 'BR'
    }, function(results, status) {
        // Restaurar botão
        if (verificarMapaBtn) {
            verificarMapaBtn.innerHTML = btnOriginalText;
            verificarMapaBtn.disabled = false;
        }
        
        console.log('Status do geocoding:', status);
        
        if (status === google.maps.GeocoderStatus.OK && results && results.length > 0) {
            const result = results[0];
            const location = result.geometry.location;
            
            console.log('Endereço encontrado:', result.formatted_address);
            console.log('Coordenadas:', location.lat(), location.lng());
            
            // Centrar mapa na localização
            map.setCenter(location);
            map.setZoom(16);
            
            // Adicionar ou mover marcador
            if (marker) {
                marker.setPosition(location);
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => {
                    marker.setAnimation(null);
                }, 1000);
            } else {
                marker = new google.maps.Marker({
                    map: map,
                    position: location,
                    animation: google.maps.Animation.DROP,
                    title: 'Seu endereço'
                });
            }
            
            // Mostrar confirmação do endereço
            const enderecoConfirmado = document.getElementById('endereco-confirmado');
            const locationConfirmation = document.getElementById('location-confirmation');
            
            if (enderecoConfirmado) {
                enderecoConfirmado.textContent = result.formatted_address;
            }
            if (locationConfirmation) {
                locationConfirmation.style.display = 'block';
            }
            
            mostrarFeedbackCep('alert-success', 'Endereço localizado com sucesso no mapa!');
            
        } else {
            console.error('Geocoding falhou:', status, results);
            
            let errorMessage = 'Não foi possível localizar este endereço no mapa.';
            
            switch(status) {
                case google.maps.GeocoderStatus.ZERO_RESULTS:
                    errorMessage = 'Endereço não encontrado. Verifique se os dados estão corretos.';
                    break;
                case google.maps.GeocoderStatus.OVER_QUERY_LIMIT:
                    errorMessage = 'Muitas consultas realizadas. Tente novamente em alguns minutos.';
                    break;
                case google.maps.GeocoderStatus.REQUEST_DENIED:
                    errorMessage = 'Solicitação negada. Verifique a configuração da API.';
                    break;
                case google.maps.GeocoderStatus.INVALID_REQUEST:
                    errorMessage = 'Dados do endereço inválidos.';
                    break;
            }
            
            mostrarFeedbackCep('alert-danger', errorMessage);
            
            const locationConfirmation = document.getElementById('location-confirmation');
            if (locationConfirmation) {
                locationConfirmation.style.display = 'none';
            }
        }
    });
}

// ========================================
// FUNÇÕES UTILITÁRIAS
// ========================================

// Função para mostrar feedback do CEP
function mostrarFeedbackCep(tipo, mensagem) {
    const cepFeedback = document.getElementById('cep-feedback');
    if (cepFeedback) {
        cepFeedback.innerHTML = `
            <div class="alert ${tipo} alert-dismissible fade show py-2" role="alert">
                <i class="bi ${tipo.includes('success') ? 'bi-check-circle-fill' : tipo.includes('warning') ? 'bi-exclamation-triangle-fill' : 'bi-x-circle-fill'} me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        cepFeedback.style.display = 'block';
        
        // Auto-hide após 5 segundos para mensagens de sucesso
        if (tipo.includes('success')) {
            setTimeout(() => {
                const alert = cepFeedback.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        cepFeedback.style.display = 'none';
                    }, 150);
                }
            }, 5000);
        }
    }
}

// Função para aplicar mascaramento de dados
function applyDataMasking(shouldMask) {
    const dataFields = document.querySelectorAll('.data-field');
    dataFields.forEach(field => {
        if (shouldMask) {
            field.classList.add('masked-data');
        } else {
            field.classList.remove('masked-data');
        }
    });
    
    // Salvar preferência em variável de memória
    dataMaskingEnabled = shouldMask;
    console.log('Mascaramento de dados:', shouldMask ? 'Ativado' : 'Desativado');
}

// Buscar CEP via API do ViaCEP
function buscarCEP(cep) {
    return fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.erro) {
                throw new Error('CEP não encontrado');
            }
            return data;
        });
}

// Formatar CEP
function formatarCEP(value) {
    // Remove tudo que não é número
    value = value.replace(/\D/g, '');
    
    // Limita a 8 dígitos
    if (value.length > 8) {
        value = value.substring(0, 8);
    }
    
    // Aplica formatação
    if (value.length > 5) {
        value = value.replace(/^(\d{5})(\d{0,3})/, "$1-$2");
    }
    
    return value;
}

// Validar senha
function validarSenha(senha) {
    const requirements = [
        { id: 'req-length', test: senha.length >= 8, text: 'Mínimo 8 caracteres' },
        { id: 'req-lowercase', test: /[a-z]/.test(senha), text: 'Letra minúscula' },
        { id: 'req-uppercase', test: /[A-Z]/.test(senha), text: 'Letra maiúscula' },
        { id: 'req-number', test: /\d/.test(senha), text: 'Número' },
        { id: 'req-special', test: /[_@$!%*?&]/.test(senha), text: 'Caractere especial' }
    ];
    
    requirements.forEach(req => {
        const element = document.getElementById(req.id);
        if (element) {
            const isValid = req.test;
            const icon = isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle text-muted';
            element.innerHTML = `<i class="bi ${icon} me-1"></i>${req.text}`;
            
            // Atualizar classe do badge
            const badge = element.closest('.badge');
            if (badge) {
                badge.classList.toggle('bg-success', isValid);
                badge.classList.toggle('text-white', isValid);
                badge.classList.toggle('bg-light', !isValid);
                badge.classList.toggle('text-dark', !isValid);
            }
        }
    });
    
    return requirements.every(req => req.test);
}

// ========================================
// EVENT LISTENERS E INICIALIZAÇÃO
// ========================================

// Aguardar carregamento da página
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado - Inicializando aplicação...');
    
    // ========================================
    // TOGGLE DE MASCARAMENTO DE DADOS
    // ========================================
    const toggleDataMasking = document.getElementById('toggleDataMasking');
    if (toggleDataMasking) {
        // Inicializar com preferência padrão
        toggleDataMasking.checked = dataMaskingEnabled;
        applyDataMasking(dataMaskingEnabled);
        
        // Ouvir mudanças no toggle
        toggleDataMasking.addEventListener('change', function() {
            applyDataMasking(this.checked);
        });
    }
    
    // ========================================
    // UPLOAD E PREVIEW DE FOTO
    // ========================================
    const fotoInput = document.getElementById('foto_perfil');
    const previewImg = document.querySelector('.preview-img');
    
    if (fotoInput && previewImg) {
        fotoInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                // Validar tipo de arquivo
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('Por favor, selecione uma imagem válida (JPEG, PNG, GIF ou WebP).');
                    this.value = '';
                    return;
                }
                
                // Validar tamanho (5MB max)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    alert('A imagem deve ter no máximo 5MB.');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewImg.style.opacity = '0';
                    setTimeout(() => {
                        previewImg.style.transition = 'opacity 0.3s ease';
                        previewImg.style.opacity = '1';
                    }, 50);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // ========================================
    // VALIDAÇÃO DE SENHA
    // ========================================
    const novaSenha = document.getElementById('nova_senha');
    const confirmarSenha = document.getElementById('confirmar_nova_senha');
    
    if (novaSenha) {
        novaSenha.addEventListener('input', function() {
            validarSenha(this.value);
            
            // Se confirmação já foi preenchida, revalidar
            if (confirmarSenha && confirmarSenha.value) {
                confirmarSenha.dispatchEvent(new Event('input'));
            }
        });
    }
    
    if (confirmarSenha && novaSenha) {
        confirmarSenha.addEventListener('input', function() {
            if (this.value !== novaSenha.value) {
                this.setCustomValidity('As senhas não coincidem');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    }
    
    // ========================================
    // FORMULÁRIO DE CONTATO
    // ========================================
    const contatoForm = document.getElementById('contato-form');
    if (contatoForm) {
        contatoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Simular envio
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                alert('Obrigado pelo contato! Responderemos em breve.');
                this.reset();
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 1500);
        });
    }
    
    // ========================================
    // FORMATAÇÃO E BUSCA DE CEP
    // ========================================
    const cepInput = document.getElementById('endereco_cep');
    const buscarCepBtn = document.getElementById('buscarCep');
    
    // Formatação automática do CEP
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            e.target.value = formatarCEP(e.target.value);
        });
        
        // Buscar CEP ao pressionar Enter
        cepInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (buscarCepBtn) {
                    buscarCepBtn.click();
                }
            }
        });
    }
    
    // Busca de CEP
    if (buscarCepBtn && cepInput) {
        buscarCepBtn.addEventListener('click', function() {
            const cep = cepInput.value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                mostrarFeedbackCep('alert-danger', 'CEP inválido. O CEP deve conter exatamente 8 dígitos.');
                cepInput.focus();
                return;
            }
            
            // Mostrar loading
            const originalHTML = buscarCepBtn.innerHTML;
            buscarCepBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            buscarCepBtn.disabled = true;
            
            // Buscar CEP
            buscarCEP(cep)
                .then(data => {
                    // Preencher campos
                    const campos = {
                        'endereco_rua': data.logradouro || '',
                        'endereco_bairro': data.bairro || '',
                        'endereco_cidade': data.localidade || '',
                        'endereco_estado': data.uf || ''
                    };
                    
                    Object.keys(campos).forEach(fieldId => {
                        const element = document.getElementById(fieldId);
                        if (element) {
                            element.value = campos[fieldId];
                            element.dispatchEvent(new Event('change'));
                        }
                    });
                    
                    mostrarFeedbackCep('alert-success', 
                        `CEP encontrado: ${data.logradouro || 'Logradouro não informado'}, ${data.bairro || ''}, ${data.localidade}/${data.uf}`);
                    
                    // Focar no próximo campo
                    const numeroField = document.getElementById('endereco_numero');
                    if (numeroField) {
                        setTimeout(() => numeroField.focus(), 100);
                    }
                    
                    // Localizar no mapa se disponível
                    if (map && geocoder) {
                        setTimeout(verificarEnderecoNoMapa, 500);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar CEP:', error);
                    mostrarFeedbackCep('alert-danger', 'Erro ao buscar CEP. Verifique o número e tente novamente.');
                })
                .finally(() => {
                    // Restaurar botão
                    buscarCepBtn.innerHTML = originalHTML;
                    buscarCepBtn.disabled = false;
                });
        });
    }
    
    // ========================================
    // GOOGLE MAPS - INICIALIZAÇÃO DE ABAS
    // ========================================
    const enderecoTab = document.getElementById('endereco-tab');
    if (enderecoTab) {
        enderecoTab.addEventListener('shown.bs.tab', function() {
            console.log('Aba de endereço aberta - Verificando mapa...');
            
            if (mapInitialized && !map) {
                console.log('API carregada, inicializando mapa...');
                setTimeout(initMap, 200);
            } else if (map) {
                console.log('Mapa já existe, redimensionando...');
                // Redimensionar mapa caso já exista
                setTimeout(() => {
                    google.maps.event.trigger(map, 'resize');
                }, 200);
            }
        });
    }
    
    // Botão para verificar endereço no mapa
    const verificarMapaBtn = document.getElementById('verificarMapa');
    if (verificarMapaBtn) {
        verificarMapaBtn.addEventListener('click', function() {
            if (!mapInitialized) {
                mostrarFeedbackCep('alert-warning', 'Aguardando carregamento do Google Maps...');
                return;
            }
            verificarEnderecoNoMapa();
        });
    }
    
    // ========================================
    // MONITORAR MUDANÇAS NOS CAMPOS DE ENDEREÇO
    // ========================================
    const enderecoInputs = [
        'endereco_rua', 'endereco_numero', 'endereco_bairro', 
        'endereco_cidade', 'endereco_estado'
    ];
    
    enderecoInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('change', function() {
                // Ocultar confirmação quando endereço mudar
                const locationConfirmation = document.getElementById('location-confirmation');
                if (locationConfirmation && locationConfirmation.style.display !== 'none') {
                    locationConfirmation.style.display = 'none';
                }
            });
        }
    });
    
    console.log('Aplicação inicializada com sucesso!');
});

// ========================================
// VERIFICAÇÃO DE CARREGAMENTO DO GOOGLE MAPS
// ========================================
window.addEventListener('load', function() {
    console.log('Página totalmente carregada');
    
    // Se o Google Maps ainda não foi carregado após o load da página
    if (!mapInitialized) {
        console.log('Google Maps não foi carregado ainda, aguardando...');
        
        let attempts = 0;
        const maxAttempts = 20; // 10 segundos (20 x 500ms)
        
        const checkGoogleMaps = setInterval(function() {
            attempts++;
            
            if (window.google && window.google.maps) {
                console.log('Google Maps detectado após', attempts * 500, 'ms');
                clearInterval(checkGoogleMaps);
                initMapCallback();
            } else if (attempts >= maxAttempts) {
                console.error('Timeout: Google Maps API não foi carregada após 10 segundos');
                clearInterval(checkGoogleMaps);
                
                // Mostrar erro apenas se a aba de endereço estiver visível
                const enderecoTab = document.querySelector('#endereco-tab.active');
                if (enderecoTab) {
                    mostrarFeedbackCep('alert-danger', 
                        'Erro ao carregar Google Maps. Verifique sua conexão com a internet e recarregue a página.');
                }
            }
        }, 500);
    }
});

// ========================================
// FUNÇÕES GLOBAIS PARA CHAMADAS EXTERNAS
// ========================================

// Função para recarregar o mapa (chamada externa)
window.reloadMap = function() {
    if (map) {
        google.maps.event.trigger(map, 'resize');
        if (marker) {
            map.setCenter(marker.getPosition());
        }
    }
};

// Função para centralizar no endereço atual (chamada externa)
window.centerMapOnAddress = function() {
    if (verificarCamposEndereco()) {
        verificarEnderecoNoMapa();
    } else {
        mostrarFeedbackCep('alert-warning', 'Preencha os campos de endereço primeiro.');
    }
};

console.log('Script carregado completamente!');
    </script>

</html>