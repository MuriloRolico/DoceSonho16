CREATE DATABASE IF NOT EXISTS doce_sonho;
USE doce_sonho;

-- ================================================
-- SCHEMA COMPLETO - DOCE SONHO
-- Sincronizado com models.py
-- ================================================


ALTER TABLE pedido ADD COLUMN criado_manualmente BOOLEAN DEFAULT FALSE;
ALTER TABLE pedido ADD COLUMN criado_por_funcionario_id INTEGER;
ALTER TABLE pedido ADD COLUMN observacoes_admin TEXT;

ALTER TABLE usuario MODIFY COLUMN foto_perfil VARCHAR(255);
ALTER TABLE usuario ADD COLUMN cpf VARCHAR(14) NULL;
select * from usuario;
ALTER TABLE usuario DROP COLUMN cpf_hash;
-- Script SQL para adicionar os novos campos na tabela usuario

-- Adicionar campo para contar tentativas de login
ALTER TABLE usuario 
ADD COLUMN tentativas_login INT DEFAULT 0;

-- Adicionar campo para data/hora do bloqueio
ALTER TABLE usuario 
ADD COLUMN bloqueado_ate DATETIME NULL;

-- Adicionar campo para registrar última tentativa
ALTER TABLE usuario 
ADD COLUMN ultima_tentativa_login DATETIME NULL;

-- Atualizar usuários existentes para garantir que não tenham valores NULL problemáticos
UPDATE usuario 
SET tentativas_login = 0 
WHERE tentativas_login IS NULL;





CREATE DATABASE IF NOT EXISTS doce_sonho;
USE doce_sonho;

-- Desabilitar verificação de chaves estrangeiras temporariamente
SET FOREIGN_KEY_CHECKS = 0;


select	* from bolo_personalizado;
select	* from carrinho_personalizado;


select	* from produto;
select	* from usuario;
select	* from pedido;


-- Remover tabelas existentes (caso queira recriar do zero)
DROP TABLE IF EXISTS item_pedido_personalizado;
DROP TABLE IF EXISTS item_pedido;
DROP TABLE IF EXISTS carrinho_personalizado;
DROP TABLE IF EXISTS carrinho;
DROP TABLE IF EXISTS log;
DROP TABLE IF EXISTS token;
DROP TABLE IF EXISTS pedido;
DROP TABLE IF EXISTS bolo_personalizado;
DROP TABLE IF EXISTS produto;
DROP TABLE IF EXISTS usuario;

-- ================================================
-- TABELA: usuario
-- ================================================
CREATE TABLE usuario (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    senha VARCHAR(200) NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    foto_perfil VARCHAR(100) NULL,
    data_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    concordou_politica BOOLEAN DEFAULT FALSE,
    
    -- Campos de endereço e segurança
    cpf_hash VARCHAR(200) NULL,
    endereco_cep VARCHAR(10) NULL,
    endereco_rua VARCHAR(200) NULL,
    endereco_numero VARCHAR(20) NULL,
    endereco_complemento VARCHAR(100) NULL,
    endereco_bairro VARCHAR(100) NULL,
    endereco_cidade VARCHAR(100) NULL,
    endereco_estado VARCHAR(2) NULL,
    
    -- Campos para recuperação de senha
    reset_token VARCHAR(100) NULL,
    reset_token_expiracao DATETIME NULL,
    ultimo_acesso DATETIME NULL,
    status VARCHAR(20) DEFAULT 'ativo',
    
    -- Campos de privacidade
    mascarar_email BOOLEAN DEFAULT TRUE,
    mascarar_cpf BOOLEAN DEFAULT TRUE,
    mascarar_endereco BOOLEAN DEFAULT TRUE,
    
    INDEX idx_usuario_email (email),
    INDEX idx_usuario_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: token
-- ================================================
CREATE TABLE token (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    token VARCHAR(500) NOT NULL,
    tipo VARCHAR(20) DEFAULT 'access',
    device_info VARCHAR(200) NULL,
    data_criacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    data_expiracao DATETIME NOT NULL,
    is_revogado BOOLEAN DEFAULT FALSE,
    
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE CASCADE,
    INDEX idx_token_token (token(255)),
    INDEX idx_token_usuario_id (usuario_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: produto
-- ================================================
CREATE TABLE produto (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT NULL,
    preco FLOAT NOT NULL,
    categoria VARCHAR(50) NOT NULL,
    imagem VARCHAR(100) NULL,
    peso FLOAT NULL,
    ingredientes TEXT NULL,
    data_validade DATETIME NULL,
    informacoes_nutricionais TEXT NULL,
    
    -- Campos para soft delete
    ativo BOOLEAN DEFAULT TRUE NOT NULL,
    data_criacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_produto_categoria (categoria),
    INDEX idx_produto_ativo (ativo)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: bolo_personalizado
-- ================================================


select * from bolo_personalizado;
CREATE TABLE bolo_personalizado (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    nome VARCHAR(100) NOT NULL DEFAULT 'Bolo Personalizado',
    massa VARCHAR(50) NOT NULL,
    recheios TEXT NOT NULL,
    cobertura VARCHAR(50) NOT NULL,
    finalizacao TEXT NULL,
    observacoes TEXT NULL,
    preco FLOAT NOT NULL,
    data_criacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    ativo BOOLEAN DEFAULT TRUE,
    
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE CASCADE,
    INDEX idx_bolo_usuario_id (usuario_id),
    INDEX idx_bolo_ativo (ativo)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: pedido
-- ================================================
CREATE TABLE pedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    data DATETIME DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'Pendente',
    total FLOAT DEFAULT 0.0,
    tipo_entrega VARCHAR(20) NULL,
    valor_frete FLOAT DEFAULT 0.0,
    endereco_entrega TEXT NULL,
    observacoes TEXT NULL,
    mercado_pago_transaction_id VARCHAR(255) NULL,
    
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE CASCADE,
    INDEX idx_pedido_usuario_id (usuario_id),
    INDEX idx_pedido_status (status),
    INDEX idx_pedido_data (data)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: item_pedido
-- ================================================
CREATE TABLE item_pedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pedido_id INT NOT NULL,
    produto_id INT NOT NULL,
    quantidade INT NOT NULL DEFAULT 1,
    preco_unitario FLOAT NOT NULL,
    
    FOREIGN KEY (pedido_id) REFERENCES pedido(id) ON DELETE CASCADE,
    FOREIGN KEY (produto_id) REFERENCES produto(id) ON DELETE RESTRICT,
    INDEX idx_item_pedido_pedido_id (pedido_id),
    INDEX idx_item_pedido_produto_id (produto_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: item_pedido_personalizado
-- ================================================
CREATE TABLE item_pedido_personalizado (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pedido_id INT NOT NULL,
    bolo_personalizado_id INT NOT NULL,
    quantidade INT NOT NULL DEFAULT 1,
    preco_unitario FLOAT NOT NULL,
    
    FOREIGN KEY (pedido_id) REFERENCES pedido(id) ON DELETE CASCADE,
    FOREIGN KEY (bolo_personalizado_id) REFERENCES bolo_personalizado(id) ON DELETE RESTRICT,
    INDEX idx_item_pedido_pers_pedido_id (pedido_id),
    INDEX idx_item_pedido_pers_bolo_id (bolo_personalizado_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: log
-- ================================================
CREATE TABLE log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tipo VARCHAR(50) NOT NULL,
    descricao TEXT NOT NULL,
    usuario_id INT NULL,
    data DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE SET NULL,
    INDEX idx_log_tipo (tipo),
    INDEX idx_log_usuario_id (usuario_id),
    INDEX idx_log_data (data)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: carrinho (CarrinhoItem no model)
-- ================================================
CREATE TABLE carrinho (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    produto_id INT NOT NULL,
    quantidade INT NOT NULL DEFAULT 1,
    data_adicao DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE CASCADE,
    FOREIGN KEY (produto_id) REFERENCES produto(id) ON DELETE CASCADE,
    INDEX idx_carrinho_usuario_id (usuario_id),
    INDEX idx_carrinho_produto_id (produto_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ================================================
-- TABELA: carrinho_personalizado (CarrinhoBoloPersonalizado no model)
-- ================================================
CREATE TABLE carrinho_personalizado (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    bolo_personalizado_id INT NOT NULL,
    quantidade INT NOT NULL DEFAULT 1,
    data_adicao DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE CASCADE,
    FOREIGN KEY (bolo_personalizado_id) REFERENCES bolo_personalizado(id) ON DELETE CASCADE,
    INDEX idx_carrinho_pers_usuario_id (usuario_id),
    INDEX idx_carrinho_pers_bolo_id (bolo_personalizado_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Reabilitar verificação de chaves estrangeiras
SET FOREIGN_KEY_CHECKS = 1;

-- ================================================
-- DADOS INICIAIS
-- ================================================

-- Usuário Admin
INSERT INTO usuario (nome, email, senha, is_admin, concordou_politica) VALUES
('Admin', 'Rolico@gmail.com', CONCAT('mysql_hash:', SHA2('1234', 256)), TRUE, TRUE);

select * from usuario;


-- Produtos
INSERT INTO produto (nome, descricao, preco, categoria, peso, ingredientes, data_validade, informacoes_nutricionais) VALUES
('Bolo de Chocolate', 'Delicioso bolo de chocolate com cobertura de ganache', 45.90, 'Bolos', 1.2,
'Farinha de trigo, açúcar, ovos, chocolate, leite, manteiga',
DATE_ADD(NOW(), INTERVAL 5 DAY),
'Porção de 100g: Calorias: 450, Carboidratos: 55g, Proteínas: 6g, Gorduras: 25g'),

('Bolo de Morango', 'Bolo de baunilha com recheio de morango', 48.90, 'Bolos', 1.0,
'Farinha de trigo, açúcar, ovos, morango, leite, baunilha',
DATE_ADD(NOW(), INTERVAL 4 DAY),
'Porção de 100g: Calorias: 400, Carboidratos: 50g, Proteínas: 5g, Gorduras: 20g'),

('Cupcake de Baunilha', 'Cupcake de baunilha com cobertura de buttercream', 8.50, 'Cupcakes', 0.1,
'Farinha, açúcar, ovos, leite, baunilha, buttercream',
DATE_ADD(NOW(), INTERVAL 3 DAY),
'Porção de 50g: Calorias: 250, Carboidratos: 35g, Proteínas: 3g, Gorduras: 12g'),

('Torta de Limão', 'Torta de limão com merengue', 39.90, 'Tortas', 0.8,
'Farinha, limão, açúcar, ovos, leite, merengue',
DATE_ADD(NOW(), INTERVAL 4 DAY),
'Porção de 100g: Calorias: 380, Carboidratos: 45g, Proteínas: 5g, Gorduras: 20g'),

('Docinhos (50 unidades)', 'Mix de brigadeiros, beijinhos e cajuzinhos', 65.00, 'Doces', 0.5,
'Leite condensado, chocolate, coco, leite em pó',
DATE_ADD(NOW(), INTERVAL 7 DAY),
'Porção de 25g: Calorias: 120, Carboidratos: 18g, Proteínas: 2g, Gorduras: 6g'),

('Bolo Red Velvet', 'Bolo vermelho aveludado com cobertura de cream cheese', 52.90, 'Bolos', 1.1,
'Farinha de trigo, açúcar, ovos, corante vermelho, cacau, cream cheese',
DATE_ADD(NOW(), INTERVAL 3 DAY),
'Porção de 100g: Calorias: 420, Carboidratos: 52g, Proteínas: 5g, Gorduras: 22g'),

('Cheesecake de Frutas Vermelhas', 'Cheesecake cremoso com calda de frutas vermelhas', 55.00, 'Tortas', 1.2,
'Cream cheese, biscoito, manteiga, açúcar, ovos, frutas vermelhas',
DATE_ADD(NOW(), INTERVAL 5 DAY),
'Porção de 100g: Calorias: 350, Carboidratos: 30g, Proteínas: 6g, Gorduras: 24g'),

('Mini Quiches (12 unidades)', 'Sabores variados: queijo, alho-poró e bacon', 35.00, 'Salgados', 0.3,
'Farinha, manteiga, ovos, creme de leite, queijo, bacon, alho-poró',
DATE_ADD(NOW(), INTERVAL 2 DAY),
'Porção de 50g: Calorias: 180, Carboidratos: 12g, Proteínas: 8g, Gorduras: 13g');

-- ================================================
-- COMANDOS ÚTEIS PARA MANUTENÇÃO
-- ================================================

-- Para limpar todas as tabelas (use com cuidado!)
/*
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE item_pedido_personalizado;
TRUNCATE TABLE item_pedido;
TRUNCATE TABLE carrinho_personalizado;
TRUNCATE TABLE carrinho;
TRUNCATE TABLE log;
TRUNCATE TABLE token;
TRUNCATE TABLE pedido;
TRUNCATE TABLE bolo_personalizado;
TRUNCATE TABLE produto;
TRUNCATE TABLE usuario;
SET FOREIGN_KEY_CHECKS = 1;
*/

-- Para verificar estrutura das tabelas
-- DESCRIBE usuario;
-- DESCRIBE produto;
select * from pedido;
-- etc...
select * from usuario;
-- Para ver todas as tabelas
-- SHOW TABLES;

-- ================================================
-- FIM DO SCHEMA
-- ================================================