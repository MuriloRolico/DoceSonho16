<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Pedido Manual - Doce Sonho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #d23f72;
            --primary-dark: #b22d5d;
            --secondary-color: #ffd6e0;
            --accent-color: #ffb3c6;
            --text-color: #2d2d2d;
            --light-text: #ffffff;
            --background-color: #fff8fa;
            --container-bg: #ffffff;
            --border-color: #f1c2ce;
            --shadow: 0 8px 20px rgba(210, 63, 114, 0.08);
            --radius: 10px;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --secondary-dark: #6c757d;
        }

        body, html {
            scroll-behavior: smooth;
            background-color: var(--background-color);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.8;
            color: var(--text-color);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.5px;
        }
        
        .mt-3 {
            margin-top: 0 !important;
        }

        /* Cards */
        .card {
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: none;
            margin-bottom: 25px;
            overflow: hidden;
            background-color: var(--container-bg);
        }

        .card-header {
            padding: 18px 25px;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h4,
        .card-header h5 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .card-body {
            padding: 25px;
        }

        /* Buttons */
        .btn {
            border-radius: 5px;
            padding: 8px 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(210, 63, 114, 0.2);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.2);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.2);
        }

        .btn-secondary {
            background-color: var(--secondary-dark);
            border-color: var(--secondary-dark);
            color: var(--light-text);
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.2);
        }

        /* Form */
        .form-label {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .form-control,
        .form-select {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(210, 63, 114, 0.15);
        }

        /* Section headers */
        .border-bottom {
            border-color: var(--border-color) !important;
        }

        h5.border-bottom {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Card bg-light */
        .card.bg-light {
            background-color: rgba(210, 63, 114, 0.03) !important;
        }

        .text-primary {
            color: var(--primary-color) !important;
        }

        /* Alert */
        .alert {
            border-radius: var(--radius);
            border: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid px-4 mt-3">
        <!-- Mensagens Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-plus-circle me-2"></i>Criar Pedido Manual
                        </h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('funcionario.novo_pedido') }}">
                            <!-- Seleção de Cliente -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">
                                    <i class="bi bi-person me-2"></i>Cliente
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="usuario_id" class="form-label">Selecione o Cliente *</label>
                                        <select class="form-select" id="usuario_id" name="usuario_id" required>
                                            <option value="">-- Selecione um cliente --</option>
                                            {% for cliente in clientes %}
                                                <option value="{{ cliente.id }}">{{ cliente.nome }} ({{ cliente.email }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Tipo de Entrega -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">
                                    <i class="bi bi-truck me-2"></i>Entrega
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="tipo_entrega" class="form-label">Tipo de Entrega *</label>
                                        <select class="form-select" id="tipo_entrega" name="tipo_entrega" required>
                                            <option value="retirada">Retirada na Loja (Grátis)</option>
                                            <option value="frete">Entrega com Frete (R$ 12,00)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                   <!-- Produtos -->
<div class="mb-4">
    <h5 class="border-bottom pb-2">
        <i class="bi bi-box-seam me-2"></i>Produtos
    </h5>
    <div id="produtos-container">
        <div class="row mb-3 produto-item">
            <div class="col-md-6">
                <label class="form-label">Tipo de Item *</label>
                <select class="form-select tipo-item-select" required>
                    <option value="">-- Selecione o tipo --</option>
                    <option value="produto">Produto Regular</option>
                    <option value="bolo_personalizado">Bolo Personalizado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Quantidade *</label>
                <input type="number" class="form-control quantidade-input" name="quantidade" min="1" value="1" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Subtotal</label>
                <input type="text" class="form-control subtotal-display" readonly value="R$ 0,00">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-sm remover-produto" style="display:none;">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <!-- Campo para Produto Regular -->
            <div class="col-12 mt-2 campo-produto" style="display:none;">
                <label class="form-label">Produto *</label>
                <select class="form-select produto-select" name="produto_id">
                    <option value="">-- Selecione um produto --</option>
                    {% for produto in produtos %}
                        <option value="{{ produto.id }}" data-preco="{{ produto.preco }}">
                            {{ produto.nome }} - R$ {{ "%.2f"|format(produto.preco) }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Campo para Bolo Personalizado -->
            <!-- Campo para Bolo Personalizado -->
<div class="col-12 mt-2 campo-bolo-personalizado" style="display:none;">
    <label class="form-label">Bolo Personalizado *</label>
    <select class="form-select bolo-select" name="bolo_personalizado_id">
        <option value="">-- Selecione um bolo --</option>
        <option value="1" data-preco="119.00">Bolo de Chocolate - R$ 119,00</option>
        <option value="2" data-preco="125.00">Bolo de Morango - R$ 125,00</option>
        <option value="3" data-preco="135.00">Bolo Red Velvet - R$ 135,00</option>
        <option value="4" data-preco="127.90">Bolo de Limão - R$ 127,90</option>
    </select>
</div>
        </div>
    </div>
    <button type="button" class="btn btn-secondary btn-sm" id="adicionar-produto">
        <i class="bi bi-plus me-1"></i>Adicionar Item
    </button>
</div>

                            <!-- Observações -->
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">
                                    <i class="bi bi-chat-text me-2"></i>Observações
                                </h5>
                                <div class="row">
                                    <div class="col-12">
                                        <label for="observacoes" class="form-label">Observações do Pedido</label>
                                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3" placeholder="Adicione observações sobre o pedido (opcional)"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Total -->
                            <div class="mb-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="mb-3">Resumo do Pedido</h5>
                                        <div class="row">
                                            <div class="col-6">
                                                <p class="mb-2"><strong>Subtotal Produtos:</strong></p>
                                            </div>
                                            <div class="col-6 text-end">
                                                <p class="mb-2" id="subtotal-produtos">R$ 0,00</p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <p class="mb-2"><strong>Frete:</strong></p>
                                            </div>
                                            <div class="col-6 text-end">
                                                <p class="mb-2" id="valor-frete">R$ 0,00</p>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <h5><strong>Total:</strong></h5>
                                            </div>
                                            <div class="col-6 text-end">
                                                <h5 class="text-primary" id="total-pedido">R$ 0,00</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botões -->
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('funcionario.pedidos') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Voltar
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle me-2"></i>Criar Pedido
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função para formatar valor em reais
        function formatarReal(valor) {
            return 'R$ ' + valor.toFixed(2).replace('.', ',');
        }

        // Função para calcular subtotal de um item
        function calcularSubtotalItem(produtoItem) {
            const tipoItem = produtoItem.querySelector('.tipo-item-select').value;
            const quantidadeInput = produtoItem.querySelector('.quantidade-input');
            const subtotalDisplay = produtoItem.querySelector('.subtotal-display');
            
            let preco = 0;
            
            if (tipoItem === 'produto') {
                const produtoSelect = produtoItem.querySelector('.produto-select');
                const selectedOption = produtoSelect.options[produtoSelect.selectedIndex];
                preco = parseFloat(selectedOption.getAttribute('data-preco')) || 0;
            } else if (tipoItem === 'bolo_personalizado') {
                const boloSelect = produtoItem.querySelector('.bolo-select');
                const selectedOption = boloSelect.options[boloSelect.selectedIndex];
                preco = parseFloat(selectedOption.getAttribute('data-preco')) || 0;
            }
            
            const quantidade = parseInt(quantidadeInput.value) || 0;
            const subtotal = preco * quantidade;
            
            subtotalDisplay.value = formatarReal(subtotal);
            return subtotal;
        }

        // Função para calcular total geral
        function calcularTotal() {
            let subtotalProdutos = 0;
            
            document.querySelectorAll('.produto-item').forEach(item => {
                subtotalProdutos += calcularSubtotalItem(item);
            });
            
            const tipoEntrega = document.getElementById('tipo_entrega').value;
            const frete = tipoEntrega === 'frete' ? 12.00 : 0.00;
            const total = subtotalProdutos + frete;
            
            document.getElementById('subtotal-produtos').textContent = formatarReal(subtotalProdutos);
            document.getElementById('valor-frete').textContent = formatarReal(frete);
            document.getElementById('total-pedido').textContent = formatarReal(total);
        }

        // Adicionar evento aos produtos existentes
        function adicionarEventosProduto(produtoItem) {
            const tipoItemSelect = produtoItem.querySelector('.tipo-item-select');
            const produtoSelect = produtoItem.querySelector('.produto-select');
            const boloSelect = produtoItem.querySelector('.bolo-select');
            const quantidadeInput = produtoItem.querySelector('.quantidade-input');
            const btnRemover = produtoItem.querySelector('.remover-produto');
            const campoProduto = produtoItem.querySelector('.campo-produto');
            const campoBoloPersonalizado = produtoItem.querySelector('.campo-bolo-personalizado');
            
            // Evento para mostrar/ocultar campos baseado no tipo
            tipoItemSelect.addEventListener('change', function() {
                const tipo = this.value;
                
                if (tipo === 'produto') {
                    campoProduto.style.display = 'block';
                    campoBoloPersonalizado.style.display = 'none';
                    produtoSelect.required = true;
                    boloSelect.required = false;
                    boloSelect.value = '';
                } else if (tipo === 'bolo_personalizado') {
                    campoProduto.style.display = 'none';
                    campoBoloPersonalizado.style.display = 'block';
                    produtoSelect.required = false;
                    boloSelect.required = true;
                    produtoSelect.value = '';
                } else {
                    campoProduto.style.display = 'none';
                    campoBoloPersonalizado.style.display = 'none';
                    produtoSelect.required = false;
                    boloSelect.required = false;
                    produtoSelect.value = '';
                    boloSelect.value = '';
                }
                
                calcularTotal();
            });
            
            produtoSelect.addEventListener('change', calcularTotal);
            boloSelect.addEventListener('change', calcularTotal);
            quantidadeInput.addEventListener('input', calcularTotal);
            
            btnRemover.addEventListener('click', function() {
                if (document.querySelectorAll('.produto-item').length > 1) {
                    produtoItem.remove();
                    calcularTotal();
                    atualizarBotoesRemover();
                }
            });
        }

        // Atualizar visibilidade dos botões remover
        function atualizarBotoesRemover() {
            const items = document.querySelectorAll('.produto-item');
            items.forEach((item, index) => {
                const btnRemover = item.querySelector('.remover-produto');
                btnRemover.style.display = items.length > 1 ? 'block' : 'none';
            });
        }

        // Adicionar produto
        document.getElementById('adicionar-produto').addEventListener('click', function() {
            const container = document.getElementById('produtos-container');
            const novoProduto = container.querySelector('.produto-item').cloneNode(true);
            
            // Limpar valores
            novoProduto.querySelector('.tipo-item-select').value = '';
            novoProduto.querySelector('.produto-select').value = '';
            novoProduto.querySelector('.bolo-select').value = '';
            novoProduto.querySelector('.quantidade-input').value = '1';
            novoProduto.querySelector('.subtotal-display').value = 'R$ 0,00';
            novoProduto.querySelector('.campo-produto').style.display = 'none';
            novoProduto.querySelector('.campo-bolo-personalizado').style.display = 'none';
            
            container.appendChild(novoProduto);
            adicionarEventosProduto(novoProduto);
            atualizarBotoesRemover();
        });

        // Evento tipo de entrega
        document.getElementById('tipo_entrega').addEventListener('change', calcularTotal);

        // Inicializar eventos no primeiro produto
        adicionarEventosProduto(document.querySelector('.produto-item'));
        atualizarBotoesRemover();
    </script>
</body>
</html>